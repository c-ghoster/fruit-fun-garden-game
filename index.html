<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@200..900&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>果彈Fun樂園排行榜</title>

    <style>
        html{
            font-size: 100%;
        }
        body {
            font-family: 'Chiron GoRound TC', sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            padding: 20px 10px;
            background-color: #efede5;
            color: #428184;
        }
        .container {
            max-width: 600px;   /* 你想限制的最大寬度 */
            margin: 0 auto;     /* 自動左右置中 */
            padding: 0 20px;    /* 手機版左右保留間距 */
        }

        .h-text {
            text-align: center;
            width: auto;
            margin: 5% auto;
        }

        .menu { 
            display: flex;               /* 使用 Flex 置中 */
            justify-content: center;     /* 水平置中 */
            flex-wrap: nowrap;             /* 不夠寬自動換行 */
            gap: 8px;                    /* 按鈕之間的距離 */
            margin: auto;
            max-width: 600px;            /* 避免在大螢幕拉太寬 */
            padding: 5px 0;
        }
        .menu2 { 
            display: none;
            justify-content: center;
            flex-wrap: nowrap;
            gap: 8px;
            margin: 5px auto;
            margin-bottom: 10px;
            max-width: 600px;
            padding: 5px 0;
        }

        button {
            font-family: 'Chiron GoRound TC', sans-serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            font-size: small;

            padding: 8px 10px;
            cursor: pointer;
            color: #428184;
            border: 1px solid #c8bda7;
            background-color: white;
            border-radius: 10px;

            white-space: nowrap;         /* 防止文字折行 */
            
            transition: background-color 0.1s, color 0.1s;
        }

        /* 高亮狀態 */
        button.active {
            background-color: #17c3B2;
            color: white;
            border-color: #13a496;
        }
        .input-c {
            display: flex;
            margin: 5px;
            margin-bottom: 30px;
        }

        input {
            display: block;
            width: 150px;
            padding: 6px;
            margin: auto;
            border-color: #ccc;
            border-style:dashed;
            border-radius: 10px;
        }

        /* HTML: <div class="loader"></div> */
        .loader {
        width: 50px;
        padding: 8px;
        aspect-ratio: 1;
        border-radius: 50%;
        background: #17c3B2;
        --_m: 
            conic-gradient(#0000 10%,#000),
            linear-gradient(#000 0 0) content-box;
        -webkit-mask: var(--_m);
                mask: var(--_m);
        -webkit-mask-composite: source-out;
                mask-composite: subtract;
        animation: l3 1s infinite linear;
        
        margin: 20px auto;      /* 自動居中 */
        display: none;
        }
        @keyframes l3 {to{transform: rotate(1turn)}}

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top:10px;
        }
        .fade-in {
            opacity: 0; /* 淡出後透明度為 0 */
        }
        .fade-in.show {
            opacity: 1; /* 淡入後透明度為 1 */
            transition: opacity 0.4s ease;
        }

        td {
            border-bottom: 1px dashed #ccc;  /* 垂直+水平線 */
            padding: 8px;
            text-align: center;
            font-size: 16px;
            background-color: white;
        }
        .td-start{
            border-left: 1px solid #ccc;
        }
        .td-end{
            border-right: 1px solid #ccc;
        }
        th {
            color: white;
            background-color: #17C3B2;
            padding: 8px;
            text-align: center;
            font-size: 16px;
        }
        .th-start{
            border-top-left-radius: 5px;
        }
        .th-end{
            border-top-right-radius: 5px;
        }

        /* 三名上色 */
        .rank-1 td { color: #FE6D73; font-size: larger; font-weight: 600;}
        .rank-2 td { color: #ff9d00;font-size: larger; font-weight: 600;}
        .rank-3 td { color: #227C9D;font-size: larger; font-weight: 600;}

        #noResult {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #noResult.show {
            opacity: 1;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1 class="h-text" style="color: #13a496; margin-bottom: 30px;">果彈Fun樂園<br>排行榜</h1>
        <div class="center">
            <p class="h-text" style="margin: 5px;">搜尋自己的名稱<br>看看你在第幾名吧～ヽ(●´∀`●)ﾉ</p>
        </div>
        <div class="input-c">
            <input id="searchInput" placeholder="搜尋名稱">
        </div>
        <div class="menu"> 
            <button data-type="point" onclick="setType('point')">累積點數</button>
            <button data-type="link" onclick="setType('link')">蔬果連連</button>
            <button data-type="harvest" onclick="setType('harvest')">採收達人</button>
        </div>

        <div class="menu2" id="modeMenu">
            <button data-mode="total" onclick="setMode('total')">累積</button>
            <button data-mode="best" onclick="setMode('best')">最高</button>
        </div>

        <div id="loading" style="text-align:center; margin:20px; margin-top: 10%; font-size:18px;" >
            資料載入中，請稍候...
        </div>
        <div class="loader" id="loader"></div>

        <table id="rankTable" class="fade-in" style="display:none;">
            <thead>
                <tr>
                    <th class="th-start">名次</th>
                    <th>名稱</th>
                    <th id="score" class="th-end">數值</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="noResult" style="display:none; text-align:center; margin:20px; color:#999;">
            沒有搜尋到符合的資料...(◞‸◟)
        </div>
    </div>


<script>

// Step 1：設定你的 Google Apps Script WebApp URL
const API_URL = "https://script.google.com/macros/s/AKfycbztfxran46xp0wsbokqEh_Bd8OVNHfq6XAqJzrvM_SZKLJ9qJ6erC8md3tBAEFUsfjN/exec";

// 全部資料儲存
let allPlayers = [];

// 目前分類（point, link, harvest）
let currentType = "point";

// 目前模式（total / best）
let currentMode = "total";

// ＝＝＝＝＝＝＝＝＝＝＝
// Step 2：載入資料（僅一次）
// ＝＝＝＝＝＝＝＝＝＝＝
async function loadData() {

    // 顯示載入提示
    document.getElementById("loading").style.display = "block";
    document.getElementById("loader").style.display = "block";
    document.getElementById("rankTable").style.display = "none";

    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        allPlayers = json.data;
        render();
        // 隱藏載入提示，顯示表格
        document.getElementById("loading").style.display = "none";
        document.getElementById("loader").style.display = "none";

    } catch (e) {
        document.getElementById("loading").innerText = "載入失敗，請重新整理頁面";
        document.getElementById("loader").style.display = "none";
        console.error(err);
    }
}



// ＝＝＝＝＝＝＝＝＝＝＝
// Step 3：切換分類
// ＝＝＝＝＝＝＝＝＝＝＝
function setType(type) {
    currentType = type;

    // 更新主類別按鈕高亮
    document.querySelectorAll(".menu button").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.type === type);
    });

    // 顯示/隱藏模式選單
    const modeMenu = document.getElementById("modeMenu");
    const needMode = (type !== "point");
    modeMenu.style.display = needMode ? "flex" : "none";

    // 每次切換到 link/harvest 時預設為 total，並高亮 total
    if (needMode) {
        if (!currentMode) currentMode = "total"; 
        setMode(currentMode);
    }
    render();
}

function setMode(mode) {
    currentMode = mode;

    // 更新模式按鈕高亮
    document.querySelectorAll("#modeMenu button").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.mode === mode);
    });

    render();
}




// ＝＝＝＝＝＝＝＝＝＝＝
// Step 4：計算競賽排名（同分名次）
// ＝＝＝＝＝＝＝＝＝＝＝
function applyRanking(list) {
    let lastScore = null;
    let lastRank = 0;

    list.forEach((p, i) => {
        if (p.score === lastScore) {
                p.rank = lastRank;
            } else {
                p.rank = i + 1;
                lastRank = p.rank;
                lastScore = p.score;
        }
    });
}


// ＝＝＝＝＝＝＝＝＝＝＝
// Step 5：資料渲染流程
// ＝＝＝＝＝＝＝＝＝＝＝
function render() {
    
    if (allPlayers.length === 0) return;
    
    const score = document.getElementById("score");
    if(currentType === 'point'){
        score.innerText='點數';
    } else {
        score.innerText='分數';
    }

    // 選擇排序欄位
    let key = "point_total";
    if (currentType === "link") {
        key = (currentMode === "best") ? "link_best" : "link_total";
    }
    if (currentType === "harvest") {
        key = (currentMode === "best") ? "harvest_best" : "harvest_total";
    }

    // 先複製資料
    let list = allPlayers
    .filter(p => p[key] !== '-' && p[key] !== '' && p[key] != null) // ★ 過濾掉 '-'
    .map(p => ({
        name: p.name,
        score: Number(p[key]) || 0
    }));


    // 排序 (高 → 低)
    list.sort((a,b) => b.score - a.score);

    // 計算名次（同分）
    applyRanking(list);

    // 搜尋
    const keyword = document.getElementById("searchInput").value.trim();
    if (keyword.length > 0) {
        list = list.filter(p => p.name.includes(keyword));
    }
    
    //判斷是否有資料
    const table = document.getElementById("rankTable");
    const noResult = document.getElementById("noResult");

    if (list.length === 0) {
        table.style.display = "none";
        noResult.style.display = "block";
        noResult.classList.add("show");
        return; // 不繼續渲染表格
    } else {
        noResult.classList.remove("show");
        noResult.style.display = "none";
        table.style.display = "table";
    }
    renderTable(list);
    
    // ＝＝＝＝動畫處理＝＝＝＝

    // 若第一次顯示 → 顯示表格但保持透明
    if (table.style.display === "none") {
        table.style.display = "table";
    }

    table.classList.remove("show");

    setTimeout(() => {
        table.classList.add('show');
    }, 0);

    
}


// ＝＝＝＝＝＝＝＝＝＝＝
// Step 6：更新表格
// ＝＝＝＝＝＝＝＝＝＝＝
function renderTable(list) {
    const tbody = document.querySelector("#rankTable tbody");
    tbody.innerHTML = "";

    list.forEach(player => {
        const tr = document.createElement("tr");

        // 前三名上色
        if (player.rank === 1) tr.classList.add("rank-1");
        if (player.rank === 2) tr.classList.add("rank-2");
        if (player.rank === 3) tr.classList.add("rank-3");

        tr.innerHTML = `
            <td class="td-start">${player.rank}</td>
            <td>${player.name}</td>
            <td class="td-end">${player.score}</td>
        `;
        tbody.appendChild(tr);
    });
}

window.onload = function () {
    currentType = "point";
    currentMode = "total";

    // 高亮主類別按鈕
    setType(currentType);

    // 若不是 point，才需要設 mode
    if (currentType !== "point") {
        setMode(currentMode);
    }

    loadData();

    document.getElementById("searchInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            render();
        }
    });

    document.getElementById("searchInput").addEventListener("input", function (e) {
        if (this.value === "") {
            render(); // 清空時自動還原
        }
    });


};

</script>

</body>
</html>
