<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>排行榜查詢系統</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
    }

    h2 {
        margin-bottom: 10px;
    }

    .menu {
        margin-bottom: 15px;
    }
    button {
        margin: 3px;
        padding: 8px 12px;
        cursor: pointer;
    }

    input {
        padding: 6px;
        margin-bottom: 10px;
        width: 200px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top:10px;
    }

    th, td {
        border: 1px solid #ccc;  /* 垂直+水平線 */
        padding: 8px;
        text-align: center;       /* 置中 */
        font-size: 16px;
    }

    th {
        background-color: #f2f2f2;
    }

    /* 三名上色 */
    .rank-1 td { background-color: gold; }
    .rank-2 td { background-color: silver; }
    .rank-3 td { background-color: #cd7f32; } /* Bronze */

</style>
</head>
<body>

<h2>排行榜查詢系統</h2>

<div class="menu">
    <button onclick="setType('point')">累積果果點數</button>
    <button onclick="setType('link')">蔬果連連</button>
    <button onclick="setType('harvest')">採收達人</button>
</div>

<div id="modeMenu" style="margin-bottom:10px; display:none;">
    <button onclick="setMode('total')">累積</button>
    <button onclick="setMode('best')">最高</button>
</div>

<input id="searchInput" placeholder="搜尋名稱" oninput="render()">

<table id="rankTable">
    <thead>
        <tr>
            <th>名次</th>
            <th>名稱</th>
            <th>數值</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>

// ⭐ Step 1：設定你的 Google Apps Script WebApp URL
const API_URL = "https://script.google.com/macros/s/AKfycbx6Nuc3rRMzDdnaP62ykXUYsKaZ2lfQ7nnZmmzrdJTCy3TitfexgdHUAYnykh9ew6BV/exec";

// ⭐ 全部資料儲存
let allPlayers = [];

// ⭐ 目前分類（point, link, harvest）
let currentType = "point";

// ⭐ 目前模式（total / best）
let currentMode = "total";

// ＝＝＝＝＝＝＝＝＝＝＝
// Step 2：載入資料（僅一次）
// ＝＝＝＝＝＝＝＝＝＝＝
async function loadData() {
    try {
        const res = await fetch(API_URL);
        const json = await res.json();
        allPlayers = json.data;
        render();
    } catch (e) {
        alert("資料載入失敗：" + e);
    }
}
loadData();


// ＝＝＝＝＝＝＝＝＝＝＝
// Step 3：切換分類
// ＝＝＝＝＝＝＝＝＝＝＝
function setType(type) {
    currentType = type;

    // Link/Harvest 顯示模式選擇
    document.getElementById("modeMenu").style.display =
        (type === "point") ? "none" : "block";

    render();
}

function setMode(mode) {
    currentMode = mode;
    render();
}


// ＝＝＝＝＝＝＝＝＝＝＝
// Step 4：計算競賽排名（同分名次）
// ＝＝＝＝＝＝＝＝＝＝＝
function applyRanking(list) {
    let lastScore = null;
    let lastRank = 0;

    list.forEach((p, i) => {
        if (p.score === lastScore) {
            p.rank = lastRank;
        } else {
            p.rank = i + 1;
            lastRank = p.rank;
            lastScore = p.score;
        }
    });
}


// ＝＝＝＝＝＝＝＝＝＝＝
// Step 5：資料渲染流程
// ＝＝＝＝＝＝＝＝＝＝＝
function render() {
    if (allPlayers.length === 0) return;

    // 選擇排序欄位
    let key = "point_total";
    if (currentType === "link") {
        key = (currentMode === "best") ? "link_best" : "link_total";
    }
    if (currentType === "harvest") {
        key = (currentMode === "best") ? "harvest_best" : "harvest_total";
    }

    // 先複製資料
    let list = allPlayers.map(p => ({
        name: p.name,
        score: Number(p[key]) || 0
    }));

    // 排序 (高 → 低)
    list.sort((a,b) => b.score - a.score);

    // 計算名次（同分）
    applyRanking(list);

    // 搜尋
    const keyword = document.getElementById("searchInput").value.trim();
    if (keyword.length > 0) {
        list = list.filter(p => p.name.includes(keyword));
    }

    // 顯示
    renderTable(list);
}


// ＝＝＝＝＝＝＝＝＝＝＝
// Step 6：更新表格
// ＝＝＝＝＝＝＝＝＝＝＝
function renderTable(list) {
    const tbody = document.querySelector("#rankTable tbody");
    tbody.innerHTML = "";

    list.forEach(player => {
        const tr = document.createElement("tr");

        // 前三名上色
        if (player.rank === 1) tr.classList.add("rank-1");
        if (player.rank === 2) tr.classList.add("rank-2");
        if (player.rank === 3) tr.classList.add("rank-3");

        tr.innerHTML = `
            <td>${player.rank}</td>
            <td>${player.name}</td>
            <td>${player.score}</td>
        `;
        tbody.appendChild(tr);
    });
}

</script>

</body>
</html>
